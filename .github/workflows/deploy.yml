name: Deploy .NET Application to Azure Windows Server VM

on:
  push:
    branches:
      - main  # Adjust the branch name as needed

jobs:
  build:
    runs-on: windows-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up .NET
        uses: actions/setup-dotnet@v3
        with:
          dotnet-version: '6.0'  # Specify the .NET version you are using

      - name: Restore dependencies
        run: dotnet restore

      - name: Build
        run: dotnet build --configuration Release --no-restore

      - name: Publish
        run: dotnet publish --configuration Release --no-build --output ./publish

      - name: Prepare deployment package
        run: |
          Compress-Archive -Path ./publish/* -DestinationPath ./app.zip

      - name: Deploy to Azure Windows Server VM
        uses: mluo0412/winrm-action@v1
        with:
          address: ${{ secrets.AZURE_VM_IP }}
          username: ${{ secrets.AZURE_VM_USERNAME }}
          password: ${{ secrets.AZURE_VM_PASSWORD }}
          command: |
            New-Item -ItemType Directory -Force -Path C:\inetpub\wwwroot\app
            Invoke-WebRequest -Uri "http://20.219.164.12/app.zip" -OutFile "C:\inetpub\wwwroot\app.zip"
            Expand-Archive -Path "C:\inetpub\wwwroot\app.zip" -DestinationPath "C:\inetpub\wwwroot\app" -Force
            Remove-Item -Path "C:\inetpub\wwwroot\app.zip"
            # Restart IIS or your application
            iisreset
